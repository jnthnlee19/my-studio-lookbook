<!-- START OF HTML -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>KB Home Lookbook</title>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    .sticky-header {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 1000;
      padding: 1rem 2rem 0.5rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    .top-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      flex-wrap: wrap;
    }
    img.logo {
      max-width: 100px;
    }
    .house-info {
      text-align: center;
      flex: 1;
      font-size: 1rem;
      font-weight: 500;
      line-height: 1.4;
    }
    .right-panel {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 0.4rem;
    }
    .total-bar {
      font-size: 1.6rem;
      font-weight: bold;
      color: #222;
      white-space: nowrap;
    }
    .top-buttons button {
      background: linear-gradient(to bottom, #FFC527, #e5b021);
      border: none;
      color: #222;
      font-weight: bold;
      padding: 0.5rem 0.8rem;
      font-size: 0.9rem;
      margin: 0.2rem 0;
      border-radius: 8px;
      cursor: pointer;
      width: 180px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    h1 {
      text-align: center;
      font-size: 1.6rem;
      margin: 1rem 0 1.5rem;
      color: #222;
    }
    #lookbook-container { padding: 1rem 2rem; }
    details { text-align: left; margin-bottom: 0.5rem; }
    summary {
      background: linear-gradient(to bottom, #FFC527, #e5b021);
      padding: 0.75rem 1rem;
      font-size: 1rem;
      font-weight: bold;
      color: #222;
      border-radius: 10px;
      cursor: pointer;
    }
    .subcategory summary {
      font-size: 0.95rem;
      border-radius: 8px;
      margin-left: 1rem;
    }
    .option {
      padding: 1rem 1rem 1rem 2rem;
      display: flex;
      gap: 1rem;
      border-top: 1px solid #ddd;
      align-items: center;
    }
    .option img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
    }
    .option-details {
      flex: 1;
    }
    .option-details strong {
      display: block;
      font-size: 1rem;
      color: #333;
    }
    .option-details em {
      color: #444;
      display: block;
      margin-top: 0.4rem;
      font-style: italic;
    }
    .option-details span {
      display: block;
      color: #666;
      margin-top: 0.3rem;
    }
    .option input[type="checkbox"] {
      transform: scale(1.3);
      margin-right: 0.5rem;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="sticky-header">
    <div class="top-row">
      <img class="logo" src="kb logo.png" alt="KB Home Logo"/>
      <div class="house-info" id="house-info"></div>
      <div class="right-panel">
        <div class="total-bar" id="total-bar">Your Total: $0</div>
        <div class="top-buttons">
          <button onclick="expandAll()">Expand All</button>
          <button onclick="collapseAll()">Collapse All</button>
          <button onclick="printFull()">Print Full Lookbook</button>
          <button onclick="printSelected()">Print Selections Only</button>
        </div>
      </div>
    </div>
    <h1>KB Home Lookbook</h1>
  </div>

  <div id="lookbook-container">Loading...</div>

  <div class="modal" id="image-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background-color: rgba(0,0,0,0.8); justify-content:center; align-items:center; z-index:1000;">
    <span onclick="closeImageModal()" style="position:absolute; top:20px; right:35px; color:white; font-size:40px; font-weight:bold; cursor:pointer;">×</span>
    <img id="modal-image" style="max-width:90%; max-height:90%;"/>
  </div>

  <script>
    function openImageModal(src) {
      const modal = document.getElementById('image-modal');
      const modalImg = document.getElementById('modal-image');
      modalImg.src = src;
      modal.style.display = 'flex';
    }

    function closeImageModal() {
      document.getElementById('image-modal').style.display = 'none';
    }

    function formatPrice(value) {
      const num = parseFloat(value);
      return isNaN(num) ? null : '$' + num.toLocaleString();
    }

    function parsePrice(value) {
      const num = parseFloat(value);
      return isNaN(num) ? 0 : num;
    }

    function updateTotal() {
      let total = 0;
      document.querySelectorAll('.option input[type="checkbox"]:checked').forEach(box => {
        const price = parseFloat(box.getAttribute('data-price'));
        if (!isNaN(price)) total += price;
      });
      document.getElementById('total-bar').textContent = `Your Total: $${total.toLocaleString()}`;
    }

    function expandAll() {
      document.querySelectorAll("details").forEach(el => el.open = true);
    }

    function collapseAll() {
      document.querySelectorAll("details").forEach(el => el.open = false);
    }

    const base64 = localStorage.getItem('workbook');
    if (!base64) {
      document.getElementById('lookbook-container').innerHTML = '<p>No workbook found. Please upload from the home page.</p>';
    } else {
      const workbook = XLSX.read(base64, { type: 'base64' });
      const sheet = XLSX.utils.sheet_to_json(workbook.Sheets['Sheet2'], { header: 1 });
      const houseInfoText = sheet[11]?.[0] || '';
      const infoParts = houseInfoText.split("  ").map(s => s.trim());
      document.getElementById('house-info').innerHTML = infoParts.map(line => `<div>${line}</div>`).join('');

      let grouped = {}, currentCategory = '', currentSubcategory = '';
      for (let i = 14; i < sheet.length; i++) {
        const row = sheet[i];
        const cellA = row[0];
        const cellC = row[2];
        if (!cellA) continue;
        if (!cellC) {
          const parts = cellA.split(' > ');
          currentCategory = parts[0]?.trim();
          currentSubcategory = parts[1]?.trim() || 'General';
          if (!grouped[currentCategory]) grouped[currentCategory] = {};
          if (!grouped[currentCategory][currentSubcategory]) grouped[currentCategory][currentSubcategory] = [];
        } else {
          grouped[currentCategory][currentSubcategory].push({
            optionNumber: cellA,
            description: cellC,
            salesDesc: row[9],
            amount: row[13]
          });
        }
      }

      const container = document.getElementById('lookbook-container');
      container.innerHTML = '';

      Object.keys(grouped).forEach(category => {
        const catDetails = document.createElement('details');
        const catSummary = document.createElement('summary');
        catSummary.textContent = category;
        catDetails.appendChild(catSummary);

        Object.keys(grouped[category]).forEach(sub => {
          const subDetails = document.createElement('details');
          subDetails.className = 'subcategory';
          const subSummary = document.createElement('summary');
          subSummary.textContent = sub;
          subDetails.appendChild(subSummary);

          grouped[category][sub].forEach(opt => {
            const optionDiv = document.createElement('div');
            optionDiv.className = 'option';

            const imageWrapper = document.createElement('div');
            imageWrapper.style.display = 'flex';
            imageWrapper.style.flexWrap = 'wrap';
            imageWrapper.style.gap = '0.5rem';

            fetch('/.netlify/functions/list-images')
              .then(res => res.json())
              .then(imageFiles => {
                const matches = imageFiles.filter(name => name.startsWith(opt.optionNumber));
                if (matches.length === 0) {
                  const placeholder = document.createElement('div');
                  placeholder.textContent = 'No image available';
                  placeholder.style.fontSize = '0.75rem';
                  placeholder.style.color = '#888';
                  placeholder.style.padding = '1rem';
                  imageWrapper.appendChild(placeholder);
                } else {
                  matches.forEach(filename => {
                    const img = document.createElement('img');
                    img.src = `images/${filename}`;
                    img.alt = filename;
                    img.addEventListener('click', () => openImageModal(img.src));

                    const box = document.createElement('div');
                    box.style.textAlign = 'center';
                    box.style.width = '100px';
                    box.appendChild(img);
                    imageWrapper.appendChild(box);
                  });
                }
              });

            const details = document.createElement('div');
            details.className = 'option-details';

            const formattedPrice = formatPrice(opt.amount);
            const rawPrice = parsePrice(opt.amount);

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.setAttribute('data-price', rawPrice);
            checkbox.addEventListener('change', updateTotal);

            details.innerHTML = `
              <strong>${opt.optionNumber} — ${opt.description}</strong>
              <em>${opt.salesDesc || ''}</em>
              <span><strong>Price:</strong> ${formattedPrice ?? (opt.amount || 'TBD')}</span>
            `;

            optionDiv.appendChild(checkbox);
            optionDiv.appendChild(imageWrapper);
            optionDiv.appendChild(details);
            subDetails.appendChild(optionDiv);
          });

          catDetails.appendChild(subDetails);
        });

        container.appendChild(catDetails);
      });
    }
  </script>
</body>
</html>
<!-- END OF HTML -->
